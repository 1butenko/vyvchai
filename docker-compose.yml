services:
  # Redis for caching
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes

  # Qdrant vector database
  qdrant:
    image: qdrant/qdrant:v1.7.4
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_data:/qdrant/storage

  # Phoenix UI for tracing
  phoenix:
    image: arizephoenix/phoenix:latest
    ports:
      - "6006:6006"
    environment:
      - PHOENIX_PORT=6006

  # Your AI Tutor application
  ai-tutor:
    build: .
    depends_on:
      - redis
      - qdrant
      - phoenix
    ports:
      - "8000:8000"  # FastAPI port
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
    environment:
      # --- Database Configuration ---
      - DATABASE_URL=postgresql://user:password@db:5432/vyvchai
      - REDIS_URL=redis://redis:6379
      - QDRANT_URL=http://qdrant:6333

      # --- LapaLLM Configuration ---
      - LAPA_LLM_BASE_URL=http://146.59.127.106:4000
      - LAPA_LLM_API_KEY=${LAPA_LLM_API_KEY:-dummy_key}
      - LAPA_LLM_MODEL=lapa
      - LAPA_LLM_EMBEDDING_MODEL=text-embedding-qwen

      # --- OpenAI Fallback ---
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}

      # --- Google API Key ---
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}

      # --- Tracing Configuration ---
      - PHOENIX_HOST=phoenix
      - PHOENIX_PORT=6006
      - LANGCHAIN_TRACING_V2=true
      - OTEL_EXPORTER_OTLP_TRACES_ENDPOINT=http://phoenix:6006/v1/traces
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://phoenix:6006/v1/traces

      # --- Application Settings ---
      - DATA_PATH=/app/data
      - LOG_LEVEL=INFO
      - ENVIRONMENT=docker

      # --- Telemetry ---
      - PROMETHEUS_PORT=8001
    command: ["uvicorn", "src.app.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]

  # PostgreSQL database
  db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=vyvchai
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  redis_data:
  qdrant_data:
  postgres_data:
